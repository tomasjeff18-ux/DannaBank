<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Danna Bank</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #001f3f;
            margin: 0;
            padding: 20px;
        }
        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header .logo img {
            height: 40px;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .header button {
            background-color: #FFD700;
            color: #001f3f;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .header button:hover {
            background-color: #FFC400;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .card ul {
            list-style: none;
            padding: 0;
        }
        .card li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .card li:last-child {
            border-bottom: none;
        }
        .card .btn-group button {
            margin-right: 5px;
        }
        .approve-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .reject-btn {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn-capital {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        #capitalHistoryContainer {
            margin-top: 20px;
        }
        .list-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">
            <img src="https://i.ibb.co/6P06Fj1/icono.png" alt="Danna Bank Logo">
        </div>
        <h1>Admin Dashboard</h1>
        <button onclick="logout()">Log out</button>
    </div>

    <div class="dashboard-container">
        <div class="card">
            <h3>Bank Status</h3>
            <p>Total users: <strong id="totalUsers">0</strong></p>
            <p>Current capital: <strong id="bankCapital">$0.00</strong></p>
        </div>
    
        <div class="card">
            <h3>Manage Capital</h3>
            <div class="form-group">
                <label for="montoCapital">Amount:</label>
                <input type="number" id="montoCapital" placeholder="Amount" required>
            </div>
            <div class="form-group">
                <label for="motivoCapital">Reason:</label>
                <textarea id="motivoCapital" placeholder="Reason for change" required></textarea>
            </div>
            <button class="btn-capital" onclick="gestionarCapital('add')">Add Capital</button>
            <button class="btn-capital" onclick="gestionarCapital('reduce')">Reduce Capital</button>
        </div>
    
        <div class="card">
            <h3>Pending Deposit Requests</h3>
            <ul id="depositRequestsList">
                <li>No pending deposit requests.</li>
            </ul>
        </div>
    
        <div class="card">
            <h3>Pending Withdrawal Requests</h3>
            <ul id="withdrawalRequestsList">
                <li>No pending withdrawal requests.</li>
            </ul>
        </div>
    
        <div class="card">
            <h3>Pending Loan Requests</h3>
            <ul id="loanRequestsList">
                <li>No pending loan requests.</li>
            </ul>
        </div>
    
        <div class="card">
            <h3>Capital History</h3>
            <ul id="capitalHistoryList">
                <li>No capital history.</li>
            </ul>
        </div>
    </div>
    
    <script>
        async function cargarDatosAdmin() {
            try {
                const response = await fetch('/api/admin/dashboard');
                const data = await response.json();
    
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('bankCapital').textContent = `$${parseFloat(data.bank_capital).toFixed(2)}`;
    
                renderRequests(data.deposit_requests, 'depositRequestsList', 'deposit');
                renderRequests(data.withdrawal_requests, 'withdrawalRequestsList', 'withdrawal');
                renderRequests(data.loan_requests, 'loanRequestsList', 'loan');
                renderCapitalHistory(data.capital_history);
            } catch (err) {
                console.error('Error loading admin dashboard:', err);
                alert('Error loading dashboard data.');
            }
        }
    
        function renderRequests(requests, listId, type) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            if (requests.length === 0) {
                list.innerHTML = `<li>No pending ${type} requests.</li>`;
                return;
            }
            requests.forEach(req => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <p><strong>User:</strong> ${req.first_name} ${req.last_name} (${req.id_number})</p>
                    <p><strong>Amount:</strong> $${parseFloat(req.amount).toFixed(2)}</p>
                    <p><strong>Date:</strong> ${new Date(req.created_at).toLocaleString()}</p>
                    <div class="btn-group">
                        <button class="approve-btn" onclick="gestionarTransaccion('${type}', ${req.id}, 'approve')">Approve</button>
                        <button class="reject-btn" onclick="gestionarTransaccion('${type}', ${req.id}, 'reject')">Reject</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }
    
        function renderCapitalHistory(history) {
            const list = document.getElementById('capitalHistoryList');
            list.innerHTML = '';
            if (history.length === 0) {
                list.innerHTML = '<li>No capital history.</li>';
                return;
            }
            history.forEach(item => {
                const li = document.createElement('li');
                const sign = item.amount >= 0 ? '+' : '';
                li.innerHTML = `
                    <p><strong>Date:</strong> ${new Date(item.created_at).toLocaleString()}</p>
                    <p><strong>Amount:</strong> <span style="color: ${item.amount >= 0 ? 'green' : 'red'};">${sign}$${parseFloat(item.amount).toFixed(2)}</span></p>
                    <p><strong>Reason:</strong> ${item.description}</p>
                `;
                list.appendChild(li);
            });
        }
    
        async function gestionarTransaccion(type, id, action) {
            if (!confirm(`Are you sure you want to ${action} this request?`)) {
                return;
            }
            try {
                const response = await fetch(`/api/admin/transaccion/${type}/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) {
                    cargarDatosAdmin();
                }
            } catch (err) {
                console.error('Error managing transaction:', err);
                alert('Error managing transaction.');
            }
        }
    
        async function gestionarCapital(accion) {
            const amount = parseFloat(document.getElementById('montoCapital').value);
            const description = document.getElementById('motivoCapital').value;
            if (isNaN(amount) || amount <= 0 || !description) {
                alert('Please enter a valid amount and a reason.');
                return;
            }
    
            try {
                const response = await fetch('/api/admin/capital', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accion, amount, description })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) {
                    cargarDatosAdmin();
                    document.getElementById('montoCapital').value = '';
                    document.getElementById('motivoCapital').value = '';
                }
            } catch (err) {
                console.error('Error managing capital:', err);
                alert('Error managing bank capital.');
            }
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', cargarDatosAdmin);
        
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
