<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Danna Bank</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #001f3f;
            margin: 0;
            padding: 20px;
        }
        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header .logo img {
            height: 40px;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .header button {
            background-color: #FFD700;
            color: #001f3f;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .header button:hover {
            background-color: #FFC400;
        }
        .info-card, .form-card, .table-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            font-weight: bold;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .data-card {
            padding: 15px;
            border-radius: 8px;
            background-color: #e9e9e9;
        }
        .data-card h3 {
            margin-top: 0;
            font-size: 1.2em;
        }
        .data-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: #003366;
        }
        form label, form input, form textarea, form button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }
        form input, form textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        form button {
            background-color: #001f3f;
            color: #fff;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        form button:hover {
            background-color: #003366;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #e9e9e9;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        .message-box {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            min-width: 300px;
            text-align: center;
        }
        .message-box.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="messageBox" class="message-box"></div>

    <div class="header">
        <div class="logo">
            <img src="Logo/Gemini_Generated_Image_xpx9nxxpx9nxxpx9.png" alt="Danna Bank Logo">
        </div>
        <h1>Panel de Administrador</h1>
        <button onclick="logout()">Cerrar Sesión</button>
    </div>

    <div class="info-card">
        <h2>Datos del Banco</h2>
        <div class="data-grid">
            <div class="data-card">
                <h3>Capital Total</h3>
                <p id="capitalTotal">$0.00</p>
            </div>
        </div>
    </div>

    <div class="form-card">
        <h2>Gestionar Capital</h2>
        <form id="capitalForm">
            <label for="montoCapital">Monto:</label>
            <input type="number" id="montoCapital" min="0.01" step="0.01" required>
            <label for="motivoCapital">Motivo:</label>
            <textarea id="motivoCapital" rows="2" required></textarea>
            <button type="button" onclick="gestionarCapital('aumentar')">Aumentar Capital</button>
            <button type="button" onclick="gestionarCapital('reducir')">Reducir Capital</button>
        </form>
    </div>
    
    <div class="table-card">
        <h2>Solicitudes Pendientes</h2>
        <table id="solicitudesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario ID</th>
                    <th>Tipo</th>
                    <th>Monto</th>
                    <th>Banco Externo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Se llenará con JS -->
            </tbody>
        </table>
    </div>

    <div class="table-card">
        <h2>Listado de Clientes</h2>
        <table id="clientesTable">
            <thead>
                <tr>
                    <th>Cédula</th>
                    <th>Nombres</th>
                    <th>Apellidos</th>
                    <th>Saldo</th>
                    <th>Correo</th>
                </tr>
            </thead>
            <tbody>
                <!-- Se llenará con JS -->
            </tbody>
        </table>
    </div>

    <script>
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
            messageBox.style.color = type === 'error' ? '#721c24' : '#155724';
            messageBox.style.border = type === 'error' ? '1px solid #f5c6cb' : '1px solid #c3e6cb';
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        async function cargarDatosAdmin() {
            const token = sessionStorage.getItem('token');
            const rol = sessionStorage.getItem('rol');
            if (rol !== 'administrador' || !token) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch('/api/admin/datos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Error al cargar datos del administrador');
                }
                const data = await response.json();
                
                document.getElementById('capitalTotal').textContent = `$${parseFloat(data.capital).toFixed(2)}`;

                // Llenar tabla de solicitudes
                const solicitudesTableBody = document.querySelector('#solicitudesTable tbody');
                solicitudesTableBody.innerHTML = '';
                data.solicitudes.forEach(solicitud => {
                    const row = solicitudesTableBody.insertRow();
                    row.insertCell(0).textContent = solicitud.id;
                    row.insertCell(1).textContent = solicitud.usuario_id;
                    row.insertCell(2).textContent = solicitud.tipo;
                    row.insertCell(3).textContent = `$${parseFloat(solicitud.monto).toFixed(2)}`;
                    row.insertCell(4).textContent = solicitud.banco_externo || 'N/A';
                    row.insertCell(5).textContent = solicitud.estado;
                    const actionsCell = row.insertCell(6);
                    actionsCell.className = 'action-buttons';
                    const approveBtn = document.createElement('button');
                    approveBtn.textContent = 'Aprobar';
                    approveBtn.onclick = () => procesarSolicitud(solicitud.id, 'aprobada');
                    const rejectBtn = document.createElement('button');
                    rejectBtn.textContent = 'Rechazar';
                    rejectBtn.onclick = () => procesarSolicitud(solicitud.id, 'rechazada');
                    actionsCell.appendChild(approveBtn);
                    actionsCell.appendChild(rejectBtn);
                });

                // Llenar tabla de clientes
                const clientesTableBody = document.querySelector('#clientesTable tbody');
                clientesTableBody.innerHTML = '';
                data.clientes.forEach(cliente => {
                    const row = clientesTableBody.insertRow();
                    row.insertCell(0).textContent = cliente.cedula;
                    row.insertCell(1).textContent = cliente.nombres;
                    row.insertCell(2).textContent = cliente.apellidos;
                    row.insertCell(3).textContent = `$${parseFloat(cliente.saldo).toFixed(2)}`;
                    row.insertCell(4).textContent = cliente.correo;
                });
            } catch (err) {
                console.error('Error al cargar los datos del administrador:', err);
                showMessage('Error al cargar los datos del administrador.', 'error');
            }
        }

        async function procesarSolicitud(solicitudId, estado) {
            const token = sessionStorage.getItem('token');
            try {
                const response = await fetch('/api/admin/solicitud/aprobar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ solicitudId, estado })
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    cargarDatosAdmin();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (err) {
                console.error('Error al procesar la solicitud:', err);
                showMessage('Error al procesar la solicitud.', 'error');
            }
        }

        async function gestionarCapital(accion) {
            const montoInput = document.getElementById('montoCapital');
            const motivoInput = document.getElementById('motivoCapital');
            const monto = parseFloat(montoInput.value);
            const motivo = motivoInput.value;
            const token = sessionStorage.getItem('token');

            if (isNaN(monto) || monto <= 0 || !motivo) {
                showMessage('Por favor, ingresa un monto válido y un motivo.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/capital', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ accion, monto, motivo })
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    cargarDatosAdmin();
                    montoInput.value = '';
                    motivoInput.value = '';
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (err) {
                console.error('Error al gestionar capital:', err);
                showMessage('Error al gestionar el capital del banco.', 'error');
            }
        }
        
        // Cargar los datos al iniciar la página
        document.addEventListener('DOMContentLoaded', cargarDatosAdmin);
        
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
